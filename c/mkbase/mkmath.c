
#include <mkbase/defs.h>
#include <mkbase/mkmath.h>

#if defined (__MACH__)
#include <libkern/OSAtomic.h>
#endif
#if defined (_MSC_VER) || defined (__WATCOMC__)
#include <sys/timeb.h>
#else
#include <sys/time.h>
#endif
#include <time.h>
#include <ctype.h>

static mk_ulreal mk_globalcnt=0;

/* ########## */
int mk_dsgn(double dd) {
  return (((((const unsigned char *)&dd)[7])>>7)>0 ? -1 : 1);
} // little endian 0 -> 7

/* ########## */
double mk_dsign(double dd) {
  return (double)mk_dsgn(dd);
}

/* ########## */
int mk_isinf(double dd) {
#if defined (_MSC_VER)
  return (_fpclass(d)==_FPCLASS_NINF ? -1 : (_fpclass(d)==_FPCLASS_PINF ? 1 : 0));
#else
  return (isinf(dd)>0 ? 1 : (isinf(dd)<0 ? -1 : 0));
#endif
}

/* ########## */
int mk_isnan(double dd) {
#if defined (_MSC_VER)
  return (_isnan(dd)==0 ? 0 : mk_dsgn(dd));
#else
  return (isnan(dd)==0 ? 0 : mk_dsgn(dd));
#endif
}

/* ########## */
int mk_isfinite(double dd) {
#if defined (_MSC_VER)
  return (_finite(dd)==0 ? 0 : mk_dsgn(dd));
#else
  return (finite(dd)==0 ? 0 : mk_dsgn(dd));
#endif
}

/* ########## */
int mk_isbusted(double dd) {
#if defined (_MSC_VER)
  return (!_isnan(dd) && _finite(dd) ? 0 : mk_dsgn(dd));
#else
  return (!isnan(dd) && finite(dd) ? 0 : mk_dsgn(dd));
#endif
}

/* ########## */
mk_ulreal mk_nextcnt() {
#if defined (__MACH__)
  OSAtomicAdd32(1,&globalcnt);
#else
  mk_globalcnt++;
#endif
  return mk_globalcnt;
}

/* ########## */
mk_ulreal mk_nextt() {

  mk_ulreal tt=0;

#if defined (_MSC_VER)
  struct __timeb64 tsec;
  _ftime64(&tsec);
  tt=(mk_ulreal)1000000*tsec.time+tsec.millitm;
#elif defined (__WATCOMC__)
  struct timeb tsec;
  ftime(&tsec);
  tt=(mk_ulreal)1000000*tsec.time+tsec.millitm;
#else
  struct timezone tzp;
  struct timeval tsec;
  gettimeofday(&tsec,&tzp);
  tt=(mk_ulreal)1000000*tsec.tv_sec+tsec.tv_usec;
#endif
  return tt;

}

/* ########## */
void mk_swapi(int *i1,int *i2) {
  int i3=*i1;
  *i1=*i2;
  *i2=i3;
}

/* ########## */
void mk_swapf(double *d1,double *d2) {
  double d3=*d1;
  *d1=*d2;
  *d2=d3;
}

/* ########## */
void mk_swapc(char **c1,char **c2) {
  char *c3=*c1;
  *c1=*c2;
  *c2=c3;
}

/* ########## */
double mk_ipow10(int nn) {

  static double powtablarge[309]={1.,1.e1,1.e2,1.e3,1.e4,1.e5,1.e6,1.e7,1.e8,1.e9,1.e10,
        1.e11,1.e12,1.e13,1.e14,1.e15,1.e16,1.e17,1.e18,1.e19,1.e20,
        1.e21,1.e22,1.e23,1.e24,1.e25,1.e26,1.e27,1.e28,1.e29,1.e30,
        1.e31,1.e32,1.e33,1.e34,1.e35,1.e36,1.e37,1.e38,1.e39,1.e40,
        1.e41,1.e42,1.e43,1.e44,1.e45,1.e46,1.e47,1.e48,1.e49,1.e50,
        1.e51,1.e52,1.e53,1.e54,1.e55,1.e56,1.e57,1.e58,1.e59,1.e60,
        1.e61,1.e62,1.e63,1.e64,1.e65,1.e66,1.e67,1.e68,1.e69,1.e70,
        1.e71,1.e72,1.e73,1.e74,1.e75,1.e76,1.e77,1.e78,1.e79,1.e80,
        1.e81,1.e82,1.e83,1.e84,1.e85,1.e86,1.e87,1.e88,1.e89,1.e90,
        1.e91,1.e92,1.e93,1.e94,1.e95,1.e96,1.e97,1.e98,1.e99,1.e100,
        1.e101,1.e102,1.e103,1.e104,1.e105,1.e106,1.e107,1.e108,1.e109,1.e110,
        1.e111,1.e112,1.e113,1.e114,1.e115,1.e116,1.e117,1.e118,1.e119,1.e120,
        1.e121,1.e122,1.e123,1.e124,1.e125,1.e126,1.e127,1.e128,1.e129,1.e130,
        1.e131,1.e132,1.e133,1.e134,1.e135,1.e136,1.e137,1.e138,1.e139,1.e140,
        1.e141,1.e142,1.e143,1.e144,1.e145,1.e146,1.e147,1.e148,1.e149,1.e150,
        1.e151,1.e152,1.e153,1.e154,1.e155,1.e156,1.e157,1.e158,1.e159,1.e160,
        1.e161,1.e162,1.e163,1.e164,1.e165,1.e166,1.e167,1.e168,1.e169,1.e170,
        1.e171,1.e172,1.e173,1.e174,1.e175,1.e176,1.e177,1.e178,1.e179,1.e180,
        1.e181,1.e182,1.e183,1.e184,1.e185,1.e186,1.e187,1.e188,1.e189,1.e190,
        1.e191,1.e192,1.e193,1.e194,1.e195,1.e196,1.e197,1.e198,1.e199,1.e200,
        1.e201,1.e202,1.e203,1.e204,1.e205,1.e206,1.e207,1.e208,1.e209,1.e210,
        1.e211,1.e212,1.e213,1.e214,1.e215,1.e216,1.e217,1.e218,1.e219,1.e220,
        1.e221,1.e222,1.e223,1.e224,1.e225,1.e226,1.e227,1.e228,1.e229,1.e230,
        1.e231,1.e232,1.e233,1.e234,1.e235,1.e236,1.e237,1.e238,1.e239,1.e240,
        1.e241,1.e242,1.e243,1.e244,1.e245,1.e246,1.e247,1.e248,1.e249,1.e250,
        1.e251,1.e252,1.e253,1.e254,1.e255,1.e256,1.e257,1.e258,1.e259,1.e260,
        1.e261,1.e262,1.e263,1.e264,1.e265,1.e266,1.e267,1.e268,1.e269,1.e270,
        1.e271,1.e272,1.e273,1.e274,1.e275,1.e276,1.e277,1.e278,1.e279,1.e280,
        1.e281,1.e282,1.e283,1.e284,1.e285,1.e286,1.e287,1.e288,1.e289,1.e290,
        1.e291,1.e292,1.e293,1.e294,1.e295,1.e296,1.e297,1.e298,1.e299,1.e300,
        1.e301,1.e302,1.e303,1.e304,1.e305,1.e306,1.e307,1.e308};

  static double powtabtiny[309]={1.,1.e-1,1.e-2,1.e-3,1.e-4,1.e-5,1.e-6,1.e-7,1.e-8,1.e-9,1.e-10,
        1.e-11,1.e-12,1.e-13,1.e-14,1.e-15,1.e-16,1.e-17,1.e-18,1.e-19,1.e-20,
        1.e-21,1.e-22,1.e-23,1.e-24,1.e-25,1.e-26,1.e-27,1.e-28,1.e-29,1.e-30,
        1.e-31,1.e-32,1.e-33,1.e-34,1.e-35,1.e-36,1.e-37,1.e-38,1.e-39,1.e-40,
        1.e-41,1.e-42,1.e-43,1.e-44,1.e-45,1.e-46,1.e-47,1.e-48,1.e-49,1.e-50,
        1.e-51,1.e-52,1.e-53,1.e-54,1.e-55,1.e-56,1.e-57,1.e-58,1.e-59,1.e-60,
        1.e-61,1.e-62,1.e-63,1.e-64,1.e-65,1.e-66,1.e-67,1.e-68,1.e-69,1.e-70,
        1.e-71,1.e-72,1.e-73,1.e-74,1.e-75,1.e-76,1.e-77,1.e-78,1.e-79,1.e-80,
        1.e-81,1.e-82,1.e-83,1.e-84,1.e-85,1.e-86,1.e-87,1.e-88,1.e-89,1.e-90,
        1.e-91,1.e-92,1.e-93,1.e-94,1.e-95,1.e-96,1.e-97,1.e-98,1.e-99,1.e-100,
        1.e-101,1.e-102,1.e-103,1.e-104,1.e-105,1.e-106,1.e-107,1.e-108,1.e-109,1.e-110,
        1.e-111,1.e-112,1.e-113,1.e-114,1.e-115,1.e-116,1.e-117,1.e-118,1.e-119,1.e-120,
        1.e-121,1.e-122,1.e-123,1.e-124,1.e-125,1.e-126,1.e-127,1.e-128,1.e-129,1.e-130,
        1.e-131,1.e-132,1.e-133,1.e-134,1.e-135,1.e-136,1.e-137,1.e-138,1.e-139,1.e-140,
        1.e-141,1.e-142,1.e-143,1.e-144,1.e-145,1.e-146,1.e-147,1.e-148,1.e-149,1.e-150,
        1.e-151,1.e-152,1.e-153,1.e-154,1.e-155,1.e-156,1.e-157,1.e-158,1.e-159,1.e-160,
        1.e-161,1.e-162,1.e-163,1.e-164,1.e-165,1.e-166,1.e-167,1.e-168,1.e-169,1.e-170,
        1.e-171,1.e-172,1.e-173,1.e-174,1.e-175,1.e-176,1.e-177,1.e-178,1.e-179,1.e-180,
        1.e-181,1.e-182,1.e-183,1.e-184,1.e-185,1.e-186,1.e-187,1.e-188,1.e-189,1.e-190,
        1.e-191,1.e-192,1.e-193,1.e-194,1.e-195,1.e-196,1.e-197,1.e-198,1.e-199,1.e-200,
        1.e-201,1.e-202,1.e-203,1.e-204,1.e-205,1.e-206,1.e-207,1.e-208,1.e-209,1.e-210,
        1.e-211,1.e-212,1.e-213,1.e-214,1.e-215,1.e-216,1.e-217,1.e-218,1.e-219,1.e-220,
        1.e-221,1.e-222,1.e-223,1.e-224,1.e-225,1.e-226,1.e-227,1.e-228,1.e-229,1.e-230,
        1.e-231,1.e-232,1.e-233,1.e-234,1.e-235,1.e-236,1.e-237,1.e-238,1.e-239,1.e-240,
        1.e-241,1.e-242,1.e-243,1.e-244,1.e-245,1.e-246,1.e-247,1.e-248,1.e-249,1.e-250,
        1.e-251,1.e-252,1.e-253,1.e-254,1.e-255,1.e-256,1.e-257,1.e-258,1.e-259,1.e-260,
        1.e-261,1.e-262,1.e-263,1.e-264,1.e-265,1.e-266,1.e-267,1.e-268,1.e-269,1.e-270,
        1.e-271,1.e-272,1.e-273,1.e-274,1.e-275,1.e-276,1.e-277,1.e-278,1.e-279,1.e-280,
        1.e-281,1.e-282,1.e-283,1.e-284,1.e-285,1.e-286,1.e-287,1.e-288,1.e-289,1.e-290,
        1.e-291,1.e-292,1.e-293,1.e-294,1.e-295,1.e-296,1.e-297,1.e-298,1.e-299,1.e-300,
        1.e-301,1.e-302,1.e-303,1.e-304,1.e-305,1.e-306,1.e-307,
#if defined (__WATCOMC__)
        .0};
#else
        1.e-308};
#endif

  if (nn>=0)
    return powtablarge[nn>308 ? 308 : nn];
  else
    return powtabtiny[nn<-308 ? 308 : -nn];

}

/* ########## */
double mk_ipow2(int nn) {
  static double powtab[1025]={1.,
        2.000000000000000e+00,4.000000000000000e+00,8.000000000000000e+00,1.600000000000000e+01,
        3.200000000000000e+01,6.400000000000000e+01,1.280000000000000e+02,2.560000000000000e+02,
        5.120000000000000e+02,1.024000000000000e+03,2.048000000000000e+03,4.096000000000000e+03,
        8.192000000000000e+03,1.638400000000000e+04,3.276800000000000e+04,6.553600000000000e+04,
        1.310720000000000e+05,2.621440000000000e+05,5.242880000000000e+05,1.048576000000000e+06,
        2.097152000000000e+06,4.194304000000000e+06,8.388608000000000e+06,1.677721600000000e+07,
        3.355443200000000e+07,6.710886400000000e+07,1.342177280000000e+08,2.684354560000000e+08,
        5.368709120000000e+08,1.073741824000000e+09,2.147483648000000e+09,4.294967296000000e+09,
        8.589934592000000e+09,1.717986918400000e+10,3.435973836800000e+10,6.871947673600000e+10,
        1.374389534720000e+11,2.748779069440000e+11,5.497558138880000e+11,1.099511627776000e+12,
        2.199023255552000e+12,4.398046511104000e+12,8.796093022208000e+12,1.759218604441600e+13,
        3.518437208883200e+13,7.036874417766400e+13,1.407374883553280e+14,2.814749767106560e+14,
        5.629499534213120e+14,1.125899906842624e+15,2.251799813685248e+15,4.503599627370496e+15,
        9.007199254740992e+15,1.801439850948198e+16,3.602879701896397e+16,7.205759403792794e+16,
        1.441151880758559e+17,2.882303761517117e+17,5.764607523034235e+17,1.152921504606847e+18,
        2.305843009213694e+18,4.611686018427388e+18,9.223372036854776e+18,1.844674407370955e+19,
        3.689348814741910e+19,7.378697629483821e+19,1.475739525896764e+20,2.951479051793528e+20,
        5.902958103587057e+20,1.180591620717411e+21,2.361183241434823e+21,4.722366482869645e+21,
        9.444732965739290e+21,1.888946593147858e+22,3.777893186295716e+22,7.555786372591432e+22,
        1.511157274518286e+23,3.022314549036573e+23,6.044629098073146e+23,1.208925819614629e+24,
        2.417851639229258e+24,4.835703278458517e+24,9.671406556917033e+24,1.934281311383407e+25,
        3.868562622766813e+25,7.737125245533627e+25,1.547425049106725e+26,3.094850098213451e+26,
        6.189700196426901e+26,1.237940039285380e+27,2.475880078570761e+27,4.951760157141521e+27,
        9.903520314283042e+27,1.980704062856608e+28,3.961408125713217e+28,7.922816251426434e+28,
        1.584563250285287e+29,3.169126500570574e+29,6.338253001141147e+29,1.267650600228229e+30,
        2.535301200456459e+30,5.070602400912918e+30,1.014120480182584e+31,2.028240960365167e+31,
        4.056481920730334e+31,8.112963841460668e+31,1.622592768292134e+32,3.245185536584267e+32,
        6.490371073168535e+32,1.298074214633707e+33,2.596148429267414e+33,5.192296858534828e+33,
        1.038459371706966e+34,2.076918743413931e+34,4.153837486827862e+34,8.307674973655724e+34,
        1.661534994731145e+35,3.323069989462290e+35,6.646139978924579e+35,1.329227995784916e+36,
        2.658455991569832e+36,5.316911983139663e+36,1.063382396627933e+37,2.126764793255865e+37,
        4.253529586511731e+37,8.507059173023462e+37,1.701411834604692e+38,3.402823669209385e+38,
        6.805647338418769e+38,1.361129467683754e+39,2.722258935367508e+39,5.444517870735015e+39,
        1.088903574147003e+40,2.177807148294006e+40,4.355614296588012e+40,8.711228593176025e+40,
        1.742245718635205e+41,3.484491437270410e+41,6.968982874540820e+41,1.393796574908164e+42,
        2.787593149816328e+42,5.575186299632656e+42,1.115037259926531e+43,2.230074519853062e+43,
        4.460149039706125e+43,8.920298079412249e+43,1.784059615882450e+44,3.568119231764900e+44,
        7.136238463529799e+44,1.427247692705960e+45,2.854495385411920e+45,5.708990770823840e+45,
        1.141798154164768e+46,2.283596308329536e+46,4.567192616659072e+46,9.134385233318143e+46,
        1.826877046663629e+47,3.653754093327257e+47,7.307508186654515e+47,1.461501637330903e+48,
        2.923003274661806e+48,5.846006549323612e+48,1.169201309864722e+49,2.338402619729445e+49,
        4.676805239458889e+49,9.353610478917779e+49,1.870722095783556e+50,3.741444191567111e+50,
        7.482888383134223e+50,1.496577676626845e+51,2.993155353253689e+51,5.986310706507378e+51,
        1.197262141301476e+52,2.394524282602951e+52,4.789048565205903e+52,9.578097130411805e+52,
        1.915619426082361e+53,3.831238852164722e+53,7.662477704329444e+53,1.532495540865889e+54,
        3.064991081731778e+54,6.129982163463555e+54,1.225996432692711e+55,2.451992865385422e+55,
        4.903985730770844e+55,9.807971461541689e+55,1.961594292308338e+56,3.923188584616675e+56,
        7.846377169233351e+56,1.569275433846670e+57,3.138550867693340e+57,6.277101735386681e+57,
        1.255420347077336e+58,2.510840694154672e+58,5.021681388309345e+58,1.004336277661869e+59,
        2.008672555323738e+59,4.017345110647476e+59,8.034690221294951e+59,1.606938044258990e+60,
        3.213876088517981e+60,6.427752177035961e+60,1.285550435407192e+61,2.571100870814384e+61,
        5.142201741628769e+61,1.028440348325754e+62,2.056880696651508e+62,4.113761393303015e+62,
        8.227522786606030e+62,1.645504557321206e+63,3.291009114642412e+63,6.582018229284824e+63,
        1.316403645856965e+64,2.632807291713930e+64,5.265614583427859e+64,1.053122916685572e+65,
        2.106245833371144e+65,4.212491666742287e+65,8.424983333484575e+65,1.684996666696915e+66,
        3.369993333393830e+66,6.739986666787660e+66,1.347997333357532e+67,2.695994666715064e+67,
        5.391989333430128e+67,1.078397866686026e+68,2.156795733372051e+68,4.313591466744102e+68,
        8.627182933488205e+68,1.725436586697641e+69,3.450873173395282e+69,6.901746346790564e+69,
        1.380349269358113e+70,2.760698538716226e+70,5.521397077432451e+70,1.104279415486490e+71,
        2.208558830972980e+71,4.417117661945961e+71,8.834235323891922e+71,1.766847064778384e+72,
        3.533694129556769e+72,7.067388259113537e+72,1.413477651822707e+73,2.826955303645415e+73,
        5.653910607290830e+73,1.130782121458166e+74,2.261564242916332e+74,4.523128485832664e+74,
        9.046256971665328e+74,1.809251394333066e+75,3.618502788666131e+75,7.237005577332262e+75,
        1.447401115466452e+76,2.894802230932905e+76,5.789604461865810e+76,1.157920892373162e+77,
        2.315841784746324e+77,4.631683569492648e+77,9.263367138985296e+77,1.852673427797059e+78,
        3.705346855594118e+78,7.410693711188237e+78,1.482138742237647e+79,2.964277484475295e+79,
        5.928554968950589e+79,1.185710993790118e+80,2.371421987580236e+80,4.742843975160471e+80,
        9.485687950320943e+80,1.897137590064189e+81,3.794275180128377e+81,7.588550360256754e+81,
        1.517710072051351e+82,3.035420144102702e+82,6.070840288205403e+82,1.214168057641081e+83,
        2.428336115282161e+83,4.856672230564323e+83,9.713344461128645e+83,1.942668892225729e+84,
        3.885337784451458e+84,7.770675568902916e+84,1.554135113780583e+85,3.108270227561167e+85,
        6.216540455122333e+85,1.243308091024467e+86,2.486616182048933e+86,4.973232364097866e+86,
        9.946464728195733e+86,1.989292945639147e+87,3.978585891278293e+87,7.957171782556586e+87,
        1.591434356511317e+88,3.182868713022635e+88,6.365737426045269e+88,1.273147485209054e+89,
        2.546294970418108e+89,5.092589940836215e+89,1.018517988167243e+90,2.037035976334486e+90,
        4.074071952668972e+90,8.148143905337944e+90,1.629628781067589e+91,3.259257562135178e+91,
        6.518515124270355e+91,1.303703024854071e+92,2.607406049708142e+92,5.214812099416284e+92,
        1.042962419883257e+93,2.085924839766514e+93,4.171849679533028e+93,8.343699359066055e+93,
        1.668739871813211e+94,3.337479743626422e+94,6.674959487252844e+94,1.334991897450569e+95,
        2.669983794901138e+95,5.339967589802275e+95,1.067993517960455e+96,2.135987035920910e+96,
        4.271974071841820e+96,8.543948143683640e+96,1.708789628736728e+97,3.417579257473456e+97,
        6.835158514946912e+97,1.367031702989382e+98,2.734063405978765e+98,5.468126811957530e+98,
        1.093625362391506e+99,2.187250724783012e+99,4.374501449566024e+99,8.749002899132048e+99,
        1.749800579826410e+100,3.499601159652819e+100,6.999202319305638e+100,1.399840463861128e+101,
        2.799680927722255e+101,5.599361855444511e+101,1.119872371088902e+102,2.239744742177804e+102,
        4.479489484355608e+102,8.958978968711217e+102,1.791795793742243e+103,3.583591587484487e+103,
        7.167183174968973e+103,1.433436634993795e+104,2.866873269987589e+104,5.733746539975179e+104,
        1.146749307995036e+105,2.293498615990072e+105,4.586997231980143e+105,9.173994463960286e+105,
        1.834798892792057e+106,3.669597785584114e+106,7.339195571168229e+106,1.467839114233646e+107,
        2.935678228467292e+107,5.871356456934583e+107,1.174271291386917e+108,2.348542582773833e+108,
        4.697085165547666e+108,9.394170331095333e+108,1.878834066219067e+109,3.757668132438133e+109,
        7.515336264876266e+109,1.503067252975253e+110,3.006134505950507e+110,6.012269011901013e+110,
        1.202453802380203e+111,2.404907604760405e+111,4.809815209520810e+111,9.619630419041621e+111,
        1.923926083808324e+112,3.847852167616648e+112,7.695704335233297e+112,1.539140867046659e+113,
        3.078281734093319e+113,6.156563468186637e+113,1.231312693637327e+114,2.462625387274655e+114,
        4.925250774549310e+114,9.850501549098620e+114,1.970100309819724e+115,3.940200619639448e+115,
        7.880401239278896e+115,1.576080247855779e+116,3.152160495711558e+116,6.304320991423117e+116,
        1.260864198284623e+117,2.521728396569247e+117,5.043456793138493e+117,1.008691358627699e+118,
        2.017382717255397e+118,4.034765434510795e+118,8.069530869021589e+118,1.613906173804318e+119,
        3.227812347608636e+119,6.455624695217271e+119,1.291124939043454e+120,2.582249878086909e+120,
        5.164499756173817e+120,1.032899951234763e+121,2.065799902469527e+121,4.131599804939054e+121,
        8.263199609878107e+121,1.652639921975621e+122,3.305279843951243e+122,6.610559687902486e+122,
        1.322111937580497e+123,2.644223875160994e+123,5.288447750321989e+123,1.057689550064398e+124,
        2.115379100128796e+124,4.230758200257591e+124,8.461516400515182e+124,1.692303280103036e+125,
        3.384606560206073e+125,6.769213120412146e+125,1.353842624082429e+126,2.707685248164858e+126,
        5.415370496329717e+126,1.083074099265943e+127,2.166148198531887e+127,4.332296397063773e+127,
        8.664592794127546e+127,1.732918558825509e+128,3.465837117651019e+128,6.931674235302037e+128,
        1.386334847060407e+129,2.772669694120815e+129,5.545339388241630e+129,1.109067877648326e+130,
        2.218135755296652e+130,4.436271510593304e+130,8.872543021186608e+130,1.774508604237322e+131,
        3.549017208474643e+131,7.098034416949286e+131,1.419606883389857e+132,2.839213766779714e+132,
        5.678427533559429e+132,1.135685506711886e+133,2.271371013423772e+133,4.542742026847543e+133,
        9.085484053695086e+133,1.817096810739017e+134,3.634193621478034e+134,7.268387242956069e+134,
        1.453677448591214e+135,2.907354897182428e+135,5.814709794364855e+135,1.162941958872971e+136,
        2.325883917745942e+136,4.651767835491884e+136,9.303535670983768e+136,1.860707134196754e+137,
        3.721414268393507e+137,7.442828536787015e+137,1.488565707357403e+138,2.977131414714806e+138,
        5.954262829429612e+138,1.190852565885922e+139,2.381705131771845e+139,4.763410263543689e+139,
        9.526820527087379e+139,1.905364105417476e+140,3.810728210834951e+140,7.621456421669903e+140,
        1.524291284333981e+141,3.048582568667961e+141,6.097165137335922e+141,1.219433027467184e+142,
        2.438866054934369e+142,4.877732109868738e+142,9.755464219737476e+142,1.951092843947495e+143,
        3.902185687894990e+143,7.804371375789981e+143,1.560874275157996e+144,3.121748550315992e+144,
        6.243497100631984e+144,1.248699420126397e+145,2.497398840252794e+145,4.994797680505588e+145,
        9.989595361011175e+145,1.997919072202235e+146,3.995838144404470e+146,7.991676288808940e+146,
        1.598335257761788e+147,3.196670515523576e+147,6.393341031047152e+147,1.278668206209430e+148,
        2.557336412418861e+148,5.114672824837722e+148,1.022934564967544e+149,2.045869129935089e+149,
        4.091738259870177e+149,8.183476519740355e+149,1.636695303948071e+150,3.273390607896142e+150,
        6.546781215792284e+150,1.309356243158457e+151,2.618712486316913e+151,5.237424972633827e+151,
        1.047484994526765e+152,2.094969989053531e+152,4.189939978107062e+152,8.379879956214123e+152,
        1.675975991242825e+153,3.351951982485649e+153,6.703903964971299e+153,1.340780792994260e+154,
        2.681561585988519e+154,5.363123171977039e+154,1.072624634395408e+155,2.145249268790816e+155,
        4.290498537581631e+155,8.580997075163262e+155,1.716199415032652e+156,3.432398830065305e+156,
        6.864797660130610e+156,1.372959532026122e+157,2.745919064052244e+157,5.491838128104488e+157,
        1.098367625620898e+158,2.196735251241795e+158,4.393470502483590e+158,8.786941004967180e+158,
        1.757388200993436e+159,3.514776401986872e+159,7.029552803973744e+159,1.405910560794749e+160,
        2.811821121589498e+160,5.623642243178995e+160,1.124728448635799e+161,2.249456897271598e+161,
        4.498913794543196e+161,8.997827589086393e+161,1.799565517817279e+162,3.599131035634557e+162,
        7.198262071269114e+162,1.439652414253823e+163,2.879304828507646e+163,5.758609657015291e+163,
        1.151721931403058e+164,2.303443862806117e+164,4.606887725612233e+164,9.213775451224466e+164,
        1.842755090244893e+165,3.685510180489786e+165,7.371020360979573e+165,1.474204072195915e+166,
        2.948408144391829e+166,5.896816288783658e+166,1.179363257756732e+167,2.358726515513463e+167,
        4.717453031026927e+167,9.434906062053853e+167,1.886981212410771e+168,3.773962424821541e+168,
        7.547924849643083e+168,1.509584969928617e+169,3.019169939857233e+169,6.038339879714466e+169,
        1.207667975942893e+170,2.415335951885786e+170,4.830671903771573e+170,9.661343807543146e+170,
        1.932268761508629e+171,3.864537523017258e+171,7.729075046034517e+171,1.545815009206903e+172,
        3.091630018413807e+172,6.183260036827613e+172,1.236652007365523e+173,2.473304014731045e+173,
        4.946608029462091e+173,9.893216058924181e+173,1.978643211784836e+174,3.957286423569673e+174,
        7.914572847139345e+174,1.582914569427869e+175,3.165829138855738e+175,6.331658277711476e+175,
        1.266331655542295e+176,2.532663311084590e+176,5.065326622169181e+176,1.013065324433836e+177,
        2.026130648867672e+177,4.052261297735345e+177,8.104522595470689e+177,1.620904519094138e+178,
        3.241809038188276e+178,6.483618076376551e+178,1.296723615275310e+179,2.593447230550621e+179,
        5.186894461101241e+179,1.037378892220248e+180,2.074757784440496e+180,4.149515568880993e+180,
        8.299031137761986e+180,1.659806227552397e+181,3.319612455104794e+181,6.639224910209589e+181,
        1.327844982041918e+182,2.655689964083835e+182,5.311379928167671e+182,1.062275985633534e+183,
        2.124551971267068e+183,4.249103942534137e+183,8.498207885068274e+183,1.699641577013655e+184,
        3.399283154027309e+184,6.798566308054619e+184,1.359713261610924e+185,2.719426523221848e+185,
        5.438853046443695e+185,1.087770609288739e+186,2.175541218577478e+186,4.351082437154956e+186,
        8.702164874309912e+186,1.740432974861982e+187,3.480865949723965e+187,6.961731899447930e+187,
        1.392346379889586e+188,2.784692759779172e+188,5.569385519558344e+188,1.113877103911669e+189,
        2.227754207823338e+189,4.455508415646675e+189,8.911016831293350e+189,1.782203366258670e+190,
        3.564406732517340e+190,7.128813465034680e+190,1.425762693006936e+191,2.851525386013872e+191,
        5.703050772027744e+191,1.140610154405549e+192,2.281220308811098e+192,4.562440617622195e+192,
        9.124881235244390e+192,1.824976247048878e+193,3.649952494097756e+193,7.299904988195512e+193,
        1.459980997639102e+194,2.919961995278205e+194,5.839923990556410e+194,1.167984798111282e+195,
        2.335969596222564e+195,4.671939192445128e+195,9.343878384890256e+195,1.868775676978051e+196,
        3.737551353956102e+196,7.475102707912205e+196,1.495020541582441e+197,2.990041083164882e+197,
        5.980082166329764e+197,1.196016433265953e+198,2.392032866531905e+198,4.784065733063811e+198,
        9.568131466127622e+198,1.913626293225524e+199,3.827252586451049e+199,7.654505172902098e+199,
        1.530901034580420e+200,3.061802069160839e+200,6.123604138321678e+200,1.224720827664336e+201,
        2.449441655328671e+201,4.898883310657342e+201,9.797766621314685e+201,1.959553324262937e+202,
        3.919106648525874e+202,7.838213297051748e+202,1.567642659410350e+203,3.135285318820699e+203,
        6.270570637641398e+203,1.254114127528280e+204,2.508228255056559e+204,5.016456510113119e+204,
        1.003291302022624e+205,2.006582604045247e+205,4.013165208090495e+205,8.026330416180990e+205,
        1.605266083236198e+206,3.210532166472396e+206,6.421064332944792e+206,1.284212866588958e+207,
        2.568425733177917e+207,5.136851466355834e+207,1.027370293271167e+208,2.054740586542333e+208,
        4.109481173084667e+208,8.218962346169334e+208,1.643792469233867e+209,3.287584938467733e+209,
        6.575169876935467e+209,1.315033975387093e+210,2.630067950774187e+210,5.260135901548374e+210,
        1.052027180309675e+211,2.104054360619349e+211,4.208108721238699e+211,8.416217442477398e+211,
        1.683243488495480e+212,3.366486976990959e+212,6.732973953981918e+212,1.346594790796384e+213,
        2.693189581592767e+213,5.386379163185534e+213,1.077275832637107e+214,2.154551665274214e+214,
        4.309103330548428e+214,8.618206661096855e+214,1.723641332219371e+215,3.447282664438742e+215,
        6.894565328877484e+215,1.378913065775497e+216,2.757826131550994e+216,5.515652263101987e+216,
        1.103130452620397e+217,2.206260905240795e+217,4.412521810481590e+217,8.825043620963180e+217,
        1.765008724192636e+218,3.530017448385272e+218,7.060034896770544e+218,1.412006979354109e+219,
        2.824013958708217e+219,5.648027917416435e+219,1.129605583483287e+220,2.259211166966574e+220,
        4.518422333933148e+220,9.036844667866296e+220,1.807368933573259e+221,3.614737867146518e+221,
        7.229475734293037e+221,1.445895146858607e+222,2.891790293717215e+222,5.783580587434429e+222,
        1.156716117486886e+223,2.313432234973772e+223,4.626864469947544e+223,9.253728939895087e+223,
        1.850745787979017e+224,3.701491575958035e+224,7.402983151916070e+224,1.480596630383214e+225,
        2.961193260766428e+225,5.922386521532856e+225,1.184477304306571e+226,2.368954608613142e+226,
        4.737909217226285e+226,9.475818434452569e+226,1.895163686890514e+227,3.790327373781028e+227,
        7.580654747562055e+227,1.516130949512411e+228,3.032261899024822e+228,6.064523798049644e+228,
        1.212904759609929e+229,2.425809519219858e+229,4.851619038439715e+229,9.703238076879431e+229,
        1.940647615375886e+230,3.881295230751772e+230,7.762590461503545e+230,1.552518092300709e+231,
        3.105036184601418e+231,6.210072369202836e+231,1.242014473840567e+232,2.484028947681134e+232,
        4.968057895362269e+232,9.936115790724537e+232,1.987223158144907e+233,3.974446316289815e+233,
        7.948892632579630e+233,1.589778526515926e+234,3.179557053031852e+234,6.359114106063704e+234,
        1.271822821212741e+235,2.543645642425482e+235,5.087291284850963e+235,1.017458256970193e+236,
        2.034916513940385e+236,4.069833027880770e+236,8.139666055761541e+236,1.627933211152308e+237,
        3.255866422304616e+237,6.511732844609233e+237,1.302346568921847e+238,2.604693137843693e+238,
        5.209386275687386e+238,1.041877255137477e+239,2.083754510274954e+239,4.167509020549909e+239,
        8.335018041099818e+239,1.667003608219964e+240,3.334007216439927e+240,6.668014432879854e+240,
        1.333602886575971e+241,2.667205773151942e+241,5.334411546303883e+241,1.066882309260777e+242,
        2.133764618521553e+242,4.267529237043107e+242,8.535058474086213e+242,1.707011694817243e+243,
        3.414023389634485e+243,6.828046779268971e+243,1.365609355853794e+244,2.731218711707588e+244,
        5.462437423415177e+244,1.092487484683035e+245,2.184974969366071e+245,4.369949938732141e+245,
        8.739899877464283e+245,1.747979975492857e+246,3.495959950985713e+246,6.991919901971426e+246,
        1.398383980394285e+247,2.796767960788570e+247,5.593535921577141e+247,1.118707184315428e+248,
        2.237414368630856e+248,4.474828737261713e+248,8.949657474523425e+248,1.789931494904685e+249,
        3.579862989809370e+249,7.159725979618740e+249,1.431945195923748e+250,2.863890391847496e+250,
        5.727780783694992e+250,1.145556156738998e+251,2.291112313477997e+251,4.582224626955994e+251,
        9.164449253911988e+251,1.832889850782398e+252,3.665779701564795e+252,7.331559403129590e+252,
        1.466311880625918e+253,2.932623761251836e+253,5.865247522503672e+253,1.173049504500734e+254,
        2.346099009001469e+254,4.692198018002938e+254,9.384396036005875e+254,1.876879207201175e+255,
        3.753758414402350e+255,7.507516828804700e+255,1.501503365760940e+256,3.003006731521880e+256,
        6.006013463043760e+256,1.201202692608752e+257,2.402405385217504e+257,4.804810770435008e+257,
        9.609621540870016e+257,1.921924308174003e+258,3.843848616348007e+258,7.687697232696013e+258,
        1.537539446539203e+259,3.075078893078405e+259,6.150157786156810e+259,1.230031557231362e+260,
        2.460063114462724e+260,4.920126228925448e+260,9.840252457850897e+260,1.968050491570179e+261,
        3.936100983140359e+261,7.872201966280717e+261,1.574440393256143e+262,3.148880786512287e+262,
        6.297761573024574e+262,1.259552314604915e+263,2.519104629209830e+263,5.038209258419659e+263,
        1.007641851683932e+264,2.015283703367864e+264,4.030567406735727e+264,8.061134813471455e+264,
        1.612226962694291e+265,3.224453925388582e+265,6.448907850777164e+265,1.289781570155433e+266,
        2.579563140310865e+266,5.159126280621731e+266,1.031825256124346e+267,2.063650512248692e+267,
        4.127301024497385e+267,8.254602048994769e+267,1.650920409798954e+268,3.301840819597908e+268,
        6.603681639195816e+268,1.320736327839163e+269,2.641472655678326e+269,5.282945311356652e+269,
        1.056589062271330e+270,2.113178124542661e+270,4.226356249085322e+270,8.452712498170644e+270,
        1.690542499634129e+271,3.381084999268258e+271,6.762169998536515e+271,1.352433999707303e+272,
        2.704867999414606e+272,5.409735998829212e+272,1.081947199765842e+273,2.163894399531685e+273,
        4.327788799063370e+273,8.655577598126739e+273,1.731115519625348e+274,3.462231039250696e+274,
        6.924462078501392e+274,1.384892415700278e+275,2.769784831400557e+275,5.539569662801113e+275,
        1.107913932560223e+276,2.215827865120445e+276,4.431655730240891e+276,8.863311460481781e+276,
        1.772662292096356e+277,3.545324584192712e+277,7.090649168385425e+277,1.418129833677085e+278,
        2.836259667354170e+278,5.672519334708340e+278,1.134503866941668e+279,2.269007733883336e+279,
        4.538015467766672e+279,9.076030935533344e+279,1.815206187106669e+280,3.630412374213338e+280,
        7.260824748426675e+280,1.452164949685335e+281,2.904329899370670e+281,5.808659798741340e+281,
        1.161731959748268e+282,2.323463919496536e+282,4.646927838993072e+282,9.293855677986144e+282,
        1.858771135597229e+283,3.717542271194458e+283,7.435084542388915e+283,1.487016908477783e+284,
        2.974033816955566e+284,5.948067633911132e+284,1.189613526782226e+285,2.379227053564453e+285,
        4.758454107128906e+285,9.516908214257812e+285,1.903381642851562e+286,3.806763285703125e+286,
        7.613526571406249e+286,1.522705314281250e+287,3.045410628562500e+287,6.090821257124999e+287,
        1.218164251425000e+288,2.436328502850000e+288,4.872657005700000e+288,9.745314011399999e+288,
        1.949062802280000e+289,3.898125604560000e+289,7.796251209119999e+289,1.559250241824000e+290,
        3.118500483648000e+290,6.237000967295999e+290,1.247400193459200e+291,2.494800386918400e+291,
        4.989600773836800e+291,9.979201547673599e+291,1.995840309534720e+292,3.991680619069440e+292,
        7.983361238138879e+292,1.596672247627776e+293,3.193344495255552e+293,6.386688990511103e+293,
        1.277337798102221e+294,2.554675596204441e+294,5.109351192408883e+294,1.021870238481777e+295,
        2.043740476963553e+295,4.087480953927106e+295,8.174961907854212e+295,1.634992381570842e+296,
        3.269984763141685e+296,6.539969526283370e+296,1.307993905256674e+297,2.615987810513348e+297,
        5.231975621026696e+297,1.046395124205339e+298,2.092790248410678e+298,4.185580496821357e+298,
        8.371160993642713e+298,1.674232198728543e+299,3.348464397457085e+299,6.696928794914171e+299,
        1.339385758982834e+300,2.678771517965668e+300,5.357543035931337e+300,1.071508607186267e+301,
        2.143017214372535e+301,4.286034428745069e+301,8.572068857490139e+301,1.714413771498028e+302,
        3.428827542996055e+302,6.857655085992111e+302,1.371531017198422e+303,2.743062034396844e+303,
        5.486124068793689e+303,1.097224813758738e+304,2.194449627517475e+304,4.388899255034951e+304,
        8.777798510069902e+304,1.755559702013980e+305,3.511119404027961e+305,7.022238808055922e+305,
        1.404447761611184e+306,2.808895523222369e+306,5.617791046444737e+306,1.123558209288947e+307,
        2.247116418577895e+307,4.494232837155790e+307,8.988465674311580e+307,1.797693134862315e+308};

  if (nn>=0)
    return powtab[nn>1024 ? 1024 : nn];
  return 1./powtab[nn<-1024 ? 1024 : -nn];

}

/* ########## */
mk_ulreal mk_binadd(mk_ulreal n1,mk_ulreal n2,int *overflow) {

  mk_ulreal res=0,sum=0;
  int ii=0,carry=0;
  for (ii=0;ii<64;ii++) {
    sum=carry+((n1>>ii)&1)+((n2>>ii)&1);
    res+=((sum&1)<<ii);
    carry=(sum>>1)&1;
    if (ii==63 && overflow && carry)
      *overflow|=1;
  }
  return res;

}

/* ########## */
mk_ulreal mk_binmult(mk_ulreal n1,mk_ulreal n2,int *overflow) {

  mk_ulreal res=0,prod=0;
  int ii=0;
  for (ii=0;ii<64;ii++) {
    prod=((n2>>ii)&1)*n1;
    res=mk_binadd(res,prod<<ii,overflow);
  }
  return res;

}

/* ########## */
int mk_isprim(int ii) {

  if (ii<2)
    return 0;
  int jj=2;
  while (jj*jj<=ii) {
    if ((ii%jj)==0)
      return 0;
    else if (jj==2)
      jj=3;
    else
      jj+=2;
  }
  return 1;

}

/* ########## */
int mk_isprim3(int ii) {

  if (mk_isprim(ii)==0) {
    if (ii%2==0 || ii%3==0)
      return 0;
  }
  return 1;

}

/* ########## */
int mk_nextlargerprim(int ii) {

  while (mk_isprim(ii)==0)
    ii++;
  return ii;

}

/* ########## */
int mk_lcm(int i1, int i2) {

  if (i1<0)
    i1=-i1;
  if (i2<0)
    i2=-i2;
  if (i1==0 || i2==0)
    return 0;
  if (i1==i2)
    return i1;
  if (i2<i1)
    mk_swapi(&i1,&i2);
  if (i1==1)
    return i2;
  if (i2%i1==0)
    return i2;
  if (i1==2)
    return 2*i2;
  if (mk_isprim(i1) || mk_isprim(i2)) {
    if (mk_isbusted((double)i1*(double)i2))
      return 0;
    return i1*i2;
  }
  int res=i2;
  while ((res%i1)!=0) {
    if (mk_isbusted((double)res+(double)i2))
      return 0;
    res+=i2;
  }
  return res;

}

/* ########## */
int mk_gcd(int i1,int i2) {

  if (i1<0)
    i1=-i1;
  if (i2<0)
    i2=-i2;
  if (i2<i1)
    mk_swapi(&i1,&i2);
  int tmp=i2%i1;
  if (!tmp)
    return i1;
  return mk_gcd(i1,tmp);

}

/* ########## */
double mk_doublemod(double x,double y) {

  if (mk_isbusted(x)!=0 || mk_isbusted(y)!=0 || mk_isbusted(x/y)!=0)
    return 1.;
  return fmod(x,y);

}

/* ########## */
int mk_mag_(int cnt,...) {

  va_list valist;
  va_start(valist,cnt);
  double num=(cnt>0 ? va_arg(valist,double) : mk_dnan);
  int incacc=(cnt>1 ? va_arg(valist,int) : 1);
  va_end(valist);

  if (mk_isbusted(num)!=0)
    return mk_dmag;
  if (num==.0)
    return 0;
  if (num<.0)
    num=-num;
  double lgnum=log10(num);
  if (incacc==1)
    lgnum+=mk_ipow10((-1)*mk_dprec);
  return (int)floor(lgnum);

}

/* ########## */
int mk_dbusted(double d1,double d2,int *cmp) {

  int sg1=mk_dsgn(d1),sg2=mk_dsgn(d2);
  if (mk_isnan(d1)) {
    if (cmp)
      *cmp=(mk_isnan(d2) ? (sg1==sg2 ? 0 : (sg1<sg2 ? -1 : 1)) : sg1);
    return 1;
  }
  if (mk_isnan(d2)) {
    if (cmp)
      *cmp=(mk_isnan(d1) ? (sg1==sg2 ? 0 : (sg1<sg2 ? -1 : 1)) : -sg2);
    return 1;
  }
  if (cmp)
    *cmp=(d1<d2 ? -1 : (d2<d1 ? 1 : 0));
  return 0;

}

/* ########## */
int mk_deq(double d1,double d2) {

  int cmp=0;
  mk_dbusted(d1,d2,&cmp);
  return (cmp==0 ? 1 : 0);

}

/* ########## */
int mk_dlt(double d1,double d2) {

  int cmp=0;
  mk_dbusted(d1,d2,&cmp);
  return (cmp<0 ? 1 : 0);

}

/* ########## */
int mk_dgt(double d1,double d2) {

  int cmp=0;
  mk_dbusted(d1,d2,&cmp);
  return (0<cmp ? 1 : 0);

}

/* ########## */
/* e.g.  diff(1.234567,1.234568)=1.e-6   and  diff(1.234567,1.234568,1e-5)=0.0 */
double mk_diff_(int cnt,...) {

  va_list valist;
  va_start(valist,cnt);
  double num1=(cnt>0 ? va_arg(valist,double) : mk_dnan);
  double num2=(cnt>1 ? va_arg(valist,double) : mk_dnan);
  double eps=(cnt>2 ? va_arg(valist,double) : 1.e-15);
  double tolerance=(cnt>3 ? va_arg(valist,double) : 1.e-6)*eps;
  va_end(valist);

  int db1=mk_isbusted(num1),db2=mk_isbusted(num2);
  if (db1!=0)
    return (db1!=db2 ? (db1<0 ? mk_dsinf : mk_dinf) : .0);
  if (db2!=0)
    return (db2<0 ? mk_dinf : mk_dsinf);
  volatile double tmp=num1-num2;
  if (mk_isbusted(tmp)!=0)
    return (mk_dsgn(tmp) ? mk_dsinf : mk_dinf);
  if (mk_isbusted(eps)!=0)
    return num1-(num1-tmp);
  if (fabs(tmp)<fabs(eps) && fabs(tmp)+tolerance<fabs(eps))
    return .0;
  /* misses tmp2>eps , but not needed for open interval ?? */
  return num1-(num1-tmp);

}

/* ########## */
double mk_logm(double val,double base) {

  if (mk_isfinite(base)==0)
    base=mk_dlimit;
  if (mk_isfinite(val)==0)
    val=mk_dlimit;
  return log(val)/log(base);

}

/* ########## */
double mk_powrat(double num,float exp) {

  if (mk_isbusted(num)!=0)
    return mk_dnan;
  double res=1.;
  if (mk_deq(exp,.0))
    return res;
  int sgn=mk_dsgn(num);
  num=fabs(num);
  if (mk_deq(num,.0))
    return .0;
  double calc=exp*log(num),tmp1=1.;
  int ii=2,jj=0;
  while (ii<mk_dmag) {
    for (jj=1;jj<ii;jj++)
      tmp1*=calc/(double)jj;
    res+=tmp1;
    tmp1=1.;
    ii++;
  }
  if (((int)exp)%2==0 || sgn==0)
    return res;
  else
    return -res;

}

/* ########## */
/*-----------------------------------------------------------------------------
round the given number at 'pos' digit after (or if negativ before) the radix point
since the first guess rounding only takes the next following digit to the rounding
point into account a precision 'eps' for recursive rounding may be given (default is 1.e-4)
that is  round(1.549999999,1,0.0)=1.5 and  round (1.549999999,1)=1.6   or
round(1.549999999,5,1e-3)=1.55   and   round(1.549999999,5,0.0)=1.54999
(! if eps will exceed the overall accuracy the effect will be as with '0.0')
approach what likely!!! is wanted
-----------------------------------------------------------------------------*/
double mk_round2_(int cnt,...) {

  va_list valist;
  va_start(valist,cnt);
  double num=(cnt>0 ? va_arg(valist,double) : mk_dnan);
  int pos=(cnt>1 ? va_arg(valist,int) : 0);
  double eps=(cnt>2 ? va_arg(valist,double) : 1.e-15);
  va_end(valist);

  int db=mk_isbusted(num);
  if (db!=0)
    return (mk_isinf(num) ? (db<0 ? mk_dsinf : mk_dinf) : (db<0 ? mk_dsnan : mk_dnan));
  double res=fabs(num);
  if (pos==0 && res<mk_uilimit)
    return mk_dsign(num)*(double)((unsigned int)(res+.5+eps));
  if ((mk_mag(res,1)+pos)>mk_dprec)
    return num;
  double sh=res*mk_ipow10(pos);
  if (sh<mk_uilimit)
    return mk_dsign(num)*(double)((unsigned int)(sh+.5+eps))*mk_ipow10(-pos);
  double expo=.0,mant=modf(sh,&expo),rderr=(double)((int)(mant+.5));
  if (rderr<1.)
    rderr=eps*((int)(mant/eps+.5));
  double rderrdiff=mk_diff(rderr,.5);
  if (rderr>.5 || rderrdiff==.0)
    expo+=1.;
  res=mk_dsign(num)*expo*mk_ipow10(-pos);
  return res;

}

/* ########## */
/*-----------------------------------------------------------------------------
round the given number up to the next double value larger than number
at the fraction digit of the given precision
that is  roundUp(1.54,0)=2.0   but  roundUp(1.54,1)=1.6
(negative values for precision are allowed so is  roundUp(1.54,-2)=100.0 )
! there may be some rare pathological cases where the routine fails !
-----------------------------------------------------------------------------*/
double mk_roundup_(int cnt,...) {

  va_list valist;
  va_start(valist,cnt);
  double num=(cnt>0 ? va_arg(valist,double) : mk_dnan);
  int maxfractiondigits=(cnt>1 ? va_arg(valist,int) : 0);
  int trailingdigits=(cnt>2 ? va_arg(valist,int) : 3);
  va_end(valist);

  int db=mk_isbusted(num);
  if (db!=0)
    return (mk_isinf(num) ? (db<0 ? mk_dsinf : mk_dinf) : (db<0 ? mk_dsnan : mk_dnan));
  double df=mk_ipow10(-maxfractiondigits-trailingdigits),zdiff=mk_diff(num,.0,df,.0);
  if (zdiff==.0)
    return mk_ipow10(-maxfractiondigits); /* return num; ?? do not know why anymore ?? */
  double temp=mk_round2(num,maxfractiondigits);
  zdiff=mk_diff(num,temp,df);
  if (zdiff==.0)
    return temp;
  if (temp<num) {
    num+=mk_ipow10(-maxfractiondigits);
    if (num>.0 && temp<.0)
      return .0; /* ref to -0.5 and resp. */
    temp=mk_round2(num,maxfractiondigits);
  }
  return temp;

}

/* ########## */
double mk_rounddown_(int cnt,...) {

  va_list valist;
  va_start(valist,cnt);
  double num=(cnt>0 ? va_arg(valist,double) : mk_dnan);
  int maxfractiondigits=(cnt>1 ? va_arg(valist,int) : 0);
  int trailingdigits=(cnt>2 ? va_arg(valist,int) : 3);
  va_end(valist);

  int db=mk_isbusted(num);
  if (db!=0)
    return (mk_isinf(num) ? (db<0 ? mk_dsinf : mk_dinf) : (db<0 ? mk_dsnan : mk_dnan));
  double df=mk_ipow10(-maxfractiondigits-trailingdigits),zdiff=mk_diff(num,.0,df);
  if (zdiff==.0)
    return num; /* return -1.0*pow(10.0,-maxFractionDigits); */
  double temp=mk_round2(num,maxfractiondigits);
  zdiff=mk_diff(num,temp,df);
  if(zdiff==.0)
    return temp;
  if (temp>num) {
    num-=mk_ipow10(-maxfractiondigits);
    temp=mk_round2(num,maxfractiondigits);
  }
  return temp;
}

struct strfi {
  double ff;
  int ii;
};

/* ########## */
static int cmpFI(const void *a1, const void *a2) {

  int ret=0;
  if (!a1 || !a2)
    return ret;
  if (((struct strfi*)a1)->ff>((struct strfi*)a2)->ff)
    ret=1;
  if (((struct strfi*)a1)->ff<((struct strfi*)a2)->ff)
    ret=-1;
  return ret;

}

/* ########## */
void mk_indextab1(int num,double arr[],int indx[]) {

  int jj=0;
  struct strfi *tmp=(struct strfi*)malloc(num*sizeof(struct strfi));
  for (jj=0;jj<num;jj++) {
    tmp[jj].ff=arr[jj];
    tmp[jj].ii=jj;
  }
  qsort((void*)tmp,(size_t)num,sizeof(struct strfi),cmpFI);
  for (jj=0;jj<num;jj++)
    indx[tmp[jj].ii]=jj;
  free(tmp);
  /* or ...
  int ii=0,jj=0,cnt=0;
  char *done=(char *)malloc(num);
  for (ii=0;ii<num;ii++) {
    done[ii]=0;
    indx[ii]=ii;
  }
  for (jj=0;jj<num;jj++) {
    cnt=0;
    for (ii=0;ii<num;ii++) {
      if (ii!=jj && arr[jj]>arr[ii]) 
        cnt++;
    }
    while(done[cnt]==1 && cnt<num) 
      cnt++;
    indx[jj]=cnt;
    done[cnt]=1;
  }
  free(done);
  ... */

}

/* ########## */
void mk_indextab2(int num,double arr[],int indx[]) {

  int ii=0;
  int *tmp=(int*)malloc(num*sizeof(int));
  mk_indextab1(num,arr,tmp);
  for (ii=0;ii<num;ii++)
    indx[tmp[ii]]=ii;
  free(tmp);

}

/* ########## */
void mk_heapsort(int nn,void **arr,int (*comp)(const void *itm1,const void *itm2)) {
  if (nn<2 || !arr || !comp)
    return;
  int ii=0,jj=0,ub=nn-1,mb=nn/2;
  void *tmp=0;
  while (mb>-1) {
    if (mb==0) { /* heap creation phase has ended - start reordering subknots */
      tmp=arr[ub]; /* make auxillary from last subknot to fill in */
      arr[ub]=arr[0];
      if (--ub==0) { /* all done - put smallest into start position */
        arr[0]=tmp;
        break;
      }
    }
    else
      tmp=arr[--mb]; /* start at last knot which has subknots and create bintree (knot>subknots) */
    ii=mb;jj=ii+ii+1; /* j is subknot index */
    while(jj<=ub) {
      if (jj<ub && comp((const void *)arr[jj],(const void *)arr[jj+1])<0)
        jj++; /* subknot is ok to its successor */
      /* promote j-pos until it is better than auxillary ... */
      if (comp((const void *)tmp,(const void *)arr[jj])<0) {
        arr[ii]=arr[jj];
        ii=jj;
        jj+=(ii+1); /* ... and make i=j as new knot with subknots from 2*j */
      }
      else
        break; //
    }
    arr[ii]=tmp; /* put the auxillary (which was small) into act subknot position */
  }
}

/* ########## */
int mk_binsearch(const void *xx,int cnt,const void **arr,int (*comp)(const void *x1,const void *x2),int guess) {
  if (!comp)
    return -1;
  int lb=-1,mb=0,ub=cnt,cmp=0,inc=1;
  const void *tmp=0;
  if (guess<=0 || guess>=cnt-1) {
    while ((ub-lb>1)) {
      mb=(ub+lb)/2;
      tmp=arr[mb];
      cmp=comp((const void*)tmp,(const void*)xx);
      if (cmp==0)
        return mb;
      if (cmp<0)
        lb=mb;
      else
        ub=mb;
    }
    return -1;
  }
  /* if a guess is given, look neighbours or narrow the interval */ 
  mb=guess;
  tmp=arr[mb];
  cmp=comp((const void*)tmp,(const void*)xx);
  if (cmp==0)
    return mb;
  if (cmp<0) {
    mb+=inc;
    while (mb<ub) {
      inc<<=1;
      tmp=arr[mb];
      cmp=comp((const void*)tmp,(const void*)xx);
      if (cmp==0)
        return mb;
      if (cmp<0) {
        lb=mb;
        mb+=inc;
      }
      else {
        ub=mb;
        break;
      }
    }
  }
  else {
    mb-=inc;
    while (mb>lb) {
      tmp=arr[mb];
      cmp=comp((const void*)tmp,(const void*)xx);
      if (cmp==0)
        return mb;
      if (cmp>0) {
        ub=mb;
        mb-=inc;
      }
      else {
        lb=mb;
        break;
      }
      inc<<=1;
    }
  }
  while ((ub-lb>1)) {
    mb=(ub+lb)/2;
    tmp=arr[mb];
    cmp=comp((const void*)tmp,(const void*)xx);
    if (cmp==0)
      return mb;
    if (cmp<0)
      lb=mb;
    else
      ub=mb;
  }
  return -1;
}


